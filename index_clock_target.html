<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>翻页时钟与倒计时</title>
    <style>
        /* 基础样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.8s ease, color 0.8s ease;
            font-family: Arial, sans-serif;
            flex-direction: column;
            padding: 20px;
        }

        /* 时钟容器布局 */
        .time-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            margin-bottom: 40px;
        }

        .time-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .time-label {
            margin-bottom: 10px;
            font-size: 18px;
            opacity: 0.9;
            display: none; /* 默认隐藏标签 */
        }

        .time-label.visible {
            display: block; /* 倒计时模式下显示 */
        }

        /* 初始默认样式（夜间） */
        .dark {
            background-color: #1e1e1e;
            color: #fff;
        }

        .light {
            background-color: #fff;
            color: #1e1e1e;
        }

        /* 时钟容器 */
        .clock {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* 翻页数字容器 */
        .flip-box {
            width: 120px;
            height: 180px;
            perspective: 1000px;
            position: relative;
        }

        /* 翻页数字 */
        .flip {
            width: 100%;
            height: 100%;
            position: absolute;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 翻页数字的前后两面 */
        .flip-front,
        .flip-back {
            width: 100%;
            height: 100%;
            position: absolute;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 80px;
            font-weight: bold;
            border-radius: 8px;
            transition: background-color 0.8s ease, color 0.8s ease, box-shadow 0.8s ease;
        }

        /* 翻页背面 */
        .flip-back {
            transform: rotateX(180deg);
        }

        /* 翻转动画 */
        .flipping {
            transform: rotateX(180deg);
        }

        /* 分隔符 */
        .separator {
            font-size: 80px;
            font-weight: bold;
            align-self: flex-start;
            margin-top: 20px;
        }

        /* 日期显示（最下方） */
        .date {
            position: absolute;
            bottom: 60px;
            font-size: 16px;
            opacity: 0.8;
            text-align: center;
        }

        /* 目标日期倒计时显示 */
        .target-countdown {
            position: absolute;
            bottom: 30px;
            font-size: 16px;
            opacity: 0.8;
            text-align: center;
        }

        /* 名言显示 */
        .motto {
            position: absolute;
            bottom: 10px;
            font-size: 14px;
            opacity: 0.7;
            text-align: center;
            font-style: italic;
        }

        /* 日出日落信息（仅自动模式显示，在日期上方） */
        .sun-info {
            position: absolute;
            bottom: 120px;
            font-size: 14px;
            opacity: 0.7;
            text-align: center;
            display: none;
        }

        /* 颜色信息（仅自动模式显示） */
        .color-info {
            position: absolute;
            bottom: 90px;
            font-size: 14px;
            opacity: 0.7;
            text-align: center;
            display: none;
        }

        /* 控制按钮容器 */
        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        /* 切换按钮 */
        .toggle-btn {
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.8s ease, color 0.8s ease;
        }

        .toggle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 选项菜单 */
        .theme-options, .countdown-options {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            border-radius: 4px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s,
                        background-color 0.8s ease, color 0.8s ease, box-shadow 0.8s ease;
            z-index: 100;
            min-width: 160px;
        }

        /* 显示选项菜单 */
        .theme-toggle-container:hover .theme-options,
        .countdown-toggle-container:hover .countdown-options {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* 选项按钮 */
        .theme-option, .countdown-option {
            display: block;
            width: 100%;
            background: none;
            border: none;
            padding: 10px 20px;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.8s ease;
        }

        .theme-option:disabled, .countdown-option:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .theme-option.active, .countdown-option.active {
            font-weight: bold;
        }

        /* 全屏按钮 */
        .fullscreen-btn {
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.8s ease, color 0.8s ease;
        }

        /* 按钮容器 */
        .toggle-container {
            position: relative;
        }

        /* 音频设置区域 */
        .audio-setting {
            padding: 10px 20px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .audio-setting-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            opacity: 0.8;
        }

        .audio-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            align-items: center;
        }

        #audioFileInput {
            flex: 1;
            min-width: 120px;
            padding: 5px 0;
            font-size: 14px;
        }

        .audio-btn {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .audio-filename {
            width: 100%;
            margin-top: 5px;
            font-size: 12px;
            opacity: 0.7;
            word-break: break-all;
        }

        /* 停止提示音按钮 */
        .stop-sound-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 1000;
        }

        .stop-sound-btn.visible {
            opacity: 1;
            visibility: visible;
        }

        /* 自定义倒计时输入框样式 */
        .custom-countdown-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .custom-countdown-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            text-align: center;
            transition: background-color 0.8s ease, color 0.8s ease;
        }

        .time-input-group {
            margin: 15px 0;
        }

        .time-input-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .time-input {
            width: 100%;
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            transition: background-color 0.8s ease, color 0.8s ease, border-color 0.3s ease;
        }

        .time-input.invalid {
            border-color: #ff4444;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .input-error {
            color: #ff4444;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .input-error.visible {
            display: block;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .modal-btn.cancel {
            opacity: 0.8;
        }

        .modal-btn:hover {
            opacity: 0.9;
        }

        .input-hint {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .flip-box {
                width: 80px;
                height: 120px;
            }
            
            .flip-front, .flip-back, .separator {
                font-size: 50px;
            }
            
            .time-label {
                font-size: 16px;
            }
            
            .controls {
                gap: 5px;
            }
            
            .toggle-btn, .fullscreen-btn {
                padding: 8px 12px;
                font-size: 14px;
            }
            
            .time-container {
                gap: 20px;
                margin-bottom: 20px;
            }

            .audio-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body class="dark">
    <!-- 控制按钮区域 -->
    <div class="controls">
        <div class="toggle-container theme-toggle-container">
            <button class="toggle-btn" id="themeToggleBtn">日夜模式</button>
            <div class="theme-options">
                <button class="theme-option" data-theme="light">白天</button>
                <button class="theme-option active" data-theme="dark">夜间</button>
                <button class="theme-option" data-theme="auto">自动</button>
            </div>
        </div>

        <div class="toggle-container countdown-toggle-container">
            <button class="toggle-btn" id="countdownToggleBtn">倒计时</button>
            <div class="countdown-options">
                <button class="countdown-option" data-time="15">15分钟</button>
                <button class="countdown-option" data-time="20">20分钟</button>
                <button class="countdown-option" data-time="60">1小时</button>
                <button class="countdown-option" data-time="custom">自定义</button>
                <button class="countdown-option" data-time="pomodoro">番茄钟</button>
                <button class="countdown-option" data-time="cancel" style="display: none;">取消倒计时</button>
                
                <!-- 音频设置 -->
                <div class="audio-setting">
                    <label class="audio-setting-label">结束提示音</label>
                    <div class="audio-controls">
                        <input type="file" id="audioFileInput" accept="audio/*" />
                        <button class="audio-btn" id="resetSoundBtn">恢复默认</button>
                        <button class="audio-btn" id="previewSoundBtn">预览</button>
                    </div>
                    <div class="audio-filename" id="audioFilename">未选择文件（使用默认提示音）</div>
                </div>
            </div>
        </div>

        <button class="fullscreen-btn" onclick="toggleFullScreen()">全屏</button>
    </div>

    <!-- 停止提示音按钮 -->
    <button class="stop-sound-btn" id="stopSoundBtn" onclick="stopSound()">停止提示音</button>

    <!-- 时间显示容器（原时钟 + 倒计时） -->
    <div class="time-container">
        <!-- 原时钟区域 -->
        <div class="time-section" id="clockSection">
            <div class="time-label" id="clockLabel">当前时间</div>
            <div class="clock" id="mainClock">
                <!-- 小时十位 -->
                <div class="flip-box">
                    <div class="flip" id="hour-tens">
                        <div class="flip-front">0</div>
                        <div class="flip-back">0</div>
                    </div>
                </div>
                <!-- 小时个位 -->
                <div class="flip-box">
                    <div class="flip" id="hour-units">
                        <div class="flip-front">0</div>
                        <div class="flip-back">0</div>
                    </div>
                </div>
                <!-- 分隔符 -->
                <div class="separator">:</div>
                <!-- 分钟十位 -->
                <div class="flip-box">
                    <div class="flip" id="minute-tens">
                        <div class="flip-front">0</div>
                        <div class="flip-back">0</div>
                    </div>
                </div>
                <!-- 分钟个位 -->
                <div class="flip-box">
                    <div class="flip" id="minute-units">
                        <div class="flip-front">0</div>
                        <div class="flip-back">0</div>
                    </div>
                </div>
                <!-- 分隔符 -->
                <div class="separator">:</div>
                <!-- 秒数十位 -->
                <div class="flip-box">
                    <div class="flip" id="second-tens">
                        <div class="flip-front">0</div>
                        <div class="flip-back">0</div>
                    </div>
                </div>
                <!-- 秒数个位 -->
                <div class="flip-box">
                    <div class="flip" id="second-units">
                        <div class="flip-front">0</div>
                        <div class="flip-back">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 倒计时区域（动态显示） -->
        <div class="time-section" id="countdownSection" style="display: none;">
            <div class="time-label" id="countdownLabel">倒计时</div>
            <div class="clock" id="countdownClock">
                <!-- 倒计时翻页元素将动态生成 -->
            </div>
        </div>
    </div>

    <!-- 日出日落信息（仅自动模式显示） -->
    <div class="sun-info" id="sun-info"></div>
    <!-- 颜色信息（仅自动模式显示） -->
    <div class="color-info" id="color-info"></div>
    <!-- 日期显示 -->
    <div class="date" id="date"></div>
    <!-- 目标日期倒计时显示 -->
    <div class="target-countdown" id="targetCountdown"></div>
    <!-- 名言显示 -->
    <div class="motto">你别忘了暑假结束前你要完成所有基础和大部分强化</div>

    <!-- 自定义倒计时模态框 -->
    <div class="custom-countdown-modal" id="customCountdownModal">
        <div class="modal-content" id="modalContent">
            <h3>设置倒计时时间</h3>
            <div class="time-input-group">
                <label class="time-input-label">小时</label>
                <input type="number" class="time-input" id="hoursInput" min="0" max="23" value="0" step="1" inputmode="numeric" pattern="[0-9]*">
                <div class="input-error" id="hoursError">请输入0-23之间的整数</div>
                <div class="input-hint">0-23之间的整数</div>
            </div>
            <div class="time-input-group">
                <label class="time-input-label">分钟</label>
                <input type="number" class="time-input" id="minutesInput" min="0" max="59" value="0" step="1" inputmode="numeric" pattern="[0-9]*">
                <div class="input-error" id="minutesError">请输入0-59之间的整数</div>
                <div class="input-hint">0-59之间的整数</div>
            </div>
            <div class="time-input-group">
                <label class="time-input-label">秒</label>
                <input type="number" class="time-input" id="secondsInput" min="0" max="59" value="0" step="1" inputmode="numeric" pattern="[0-9]*">
                <div class="input-error" id="secondsError">请输入0-59之间的整数</div>
                <div class="input-hint">0-59之间的整数</div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeCustomCountdownModal()">取消</button>
                <button class="modal-btn confirm" onclick="confirmCustomCountdown()">确认</button>
            </div>
        </div>
    </div>

    <!-- 番茄钟设置模态框 -->
    <div class="custom-countdown-modal" id="pomodoroModal">
        <div class="modal-content" id="pomodoroModalContent">
            <h3>设置番茄钟</h3>
            <div class="time-input-group">
                <label class="time-input-label">工作/学习时间（分钟）</label>
                <input type="number" class="time-input" id="workMinutesInput" min="1" max="60" value="25" step="1" inputmode="numeric" pattern="[0-9]*">
                <div class="input-error" id="workMinutesError">请输入1-60之间的整数</div>
                <div class="input-hint">默认25分钟，1-60之间的整数</div>
            </div>
            <div class="time-input-group">
                <label class="time-input-label">休息时间（分钟）</label>
                <input type="number" class="time-input" id="restMinutesInput" min="1" max="30" value="5" step="1" inputmode="numeric" pattern="[0-9]*">
                <div class="input-error" id="restMinutesError">请输入1-30之间的整数</div>
                <div class="input-hint">默认5分钟，1-30之间的整数</div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closePomodoroModal()">取消</button>
                <button class="modal-btn confirm" onclick="confirmPomodoro()">确认</button>
            </div>
        </div>
    </div>

	<!-- 目标输入模态框（优化版） -->
	<div class="custom-countdown-modal" id="goalInputModal">
	    <div class="modal-content" id="goalModalContent" style="width: 500px; max-width: 92vw; padding: 30px; border-radius: 10px;">
	        <h3 style="margin: 0 0 25px 0; padding-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.1);">设置倒计时目标</h3>
	        
	        <!-- 输入框区域 -->
	        <div style="margin-bottom: 20px;">
	            <input type="text" class="time-input" id="goalInput" 
	                   placeholder="请输入具体、可完成的任务目标（例如：完成2道数学大题、整理英语笔记第3单元）"
	                   maxlength="50"
	                   style="width: 100%; padding: 15px; font-size: 18px; border-radius: 6px; margin-bottom: 10px;">
	            
	            <!-- 字数统计和错误提示 -->
	            <div style="display: flex; justify-content: space-between; align-items: center;">
	                <span id="charCount" style="font-size: 13px; opacity: 0.7;">0/50 字</span>
	                <span id="goalError" class="input-error" style="margin: 0; font-size: 13px;">请输入至少5个字的目标（清晰描述任务）</span>
	            </div>
	        </div>
	        
	        <!-- 建议区域 -->
	        <div style="background-color: rgba(0,0,0,0.03); padding: 18px; border-radius: 6px; margin: 0 0 25px 0; font-size: 14px; line-height: 1.7;">
	            <p style="margin: 0 0 12px 0; font-weight: bold;">设置技巧参考：</p>
	            <ul style="margin: 0; padding-left: 22px; list-style-type: decimal;">
	                <li style="margin-bottom: 8px;">15分钟：可写1-2道题、背10个单词、整理一篇短文思路</li>
	                <li style="margin-bottom: 8px;">30分钟：可复习1个章节、做1套选择题、练习听力3篇</li>
	                <li>1小时：可完成1篇作文、深入研究1个知识点、整理一份详细笔记</li>
	            </ul>
	        </div>
	        
	        <!-- 按钮区域 -->
	        <div class="modal-buttons" style="margin-top: 10px; justify-content: flex-end;">
	            <button class="modal-btn cancel" onclick="closeGoalInputModal()" style="padding: 11px 22px; margin-right: 10px; font-size: 15px;">取消</button>
	            <button class="modal-btn confirm" onclick="confirmGoalInput()" style="padding: 11px 24px; font-size: 15px;">确认</button>
	        </div>
	    </div>
	</div>

    <script>
        // 全局变量
        let currentTheme = 'dark'; // 默认夜间模式
        let sunrise = null; // 日出时间（分钟，通过API获取）
        let sunset = null;   // 日落时间（分钟，通过API获取）
        let solarNoon = null; // 正午时间（分钟）
        const midnight = 0;   // 午夜时间（分钟）
        let lastHue = 180; // 记录上一秒色相，确保平滑过渡
		// 目标输入相关变量（新增）
		let pendingDuration = 0; // 暂存即将启动的倒计时时长（毫秒）
		let pendingType = ''; // 暂存倒计时类型（normal/pomodoro）
		let currentGoal = ''; // 当前倒计时的目标
        // 经纬度设置（可根据需要修改）
        const lat = 36.316667; // 纬度
        const lng = 120.366667; // 经度
        
        // 目标日期设置（可修改为任意日期）
        const targetDate = new Date(2025, 7, 31); // 月份是0-based，所以8月是7
        
        // 倒计时相关变量
        let isCountdownActive = false;
        let countdownEndTime = null;
        let selectedAudioFile = null; // 选中的音频文件
        let originalUpdateTime = null;
        let currentAudio = null; // 当前播放的音频对象
        let audioContext = null; // Web Audio API上下文
        
        // 番茄钟相关变量
        let isPomodoroActive = false;
        let isWorkPhase = true; // true:工作阶段 false:休息阶段
        let workMinutes = 25;
        let restMinutes = 5;
        
        // 基础主题颜色（严格保持静态主题不变）
        const darkColors = {
            background: [15, 15, 15],     // 午夜最暗（纯黑）
            text: [240, 240, 240],        // 夜间文字
            flip: [40, 40, 40],           // 夜间翻页块
            buttonHover: [60, 60, 60]
        };
        
        const lightColors = {
            background: [255, 255, 255],  // 正午最亮（纯白）
            text: [15, 15, 15],           // 白天文字
            flip: [240, 240, 240],        // 白天翻页块
            buttonHover: [220, 220, 220]
        };

        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            applyStaticTheme('dark');
            updateTime();
            originalUpdateTime = window.updateTime; // 保存原始更新函数
            setInterval(() => {
                window.updateTime(); // 用动态函数引用，支持切换模式
            }, 1000);
            setupThemeOptions();
            setupCountdownOptions();
            setupAudioInput();
            setupTimeInputValidation(); // 添加输入验证设置
            setupAudioButtons(); // 初始化音频按钮事件
            setupPomodoroInputValidation(); // 初始化番茄钟输入验证
            
            // 为番茄钟选项添加点击事件
            document.querySelector('.countdown-option[data-time="pomodoro"]').addEventListener('click', () => {
                if (!isCountdownActive) {
                    openPomodoroModal();
                }
            });
            
            // 初始化模态框样式
            updateModalTheme();
            updatePomodoroModalTheme();
            
            // 监听主题变化，同步更新番茄钟模态框
            const observer = new MutationObserver(() => {
                updatePomodoroModalTheme();
            });
            observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
			
			// 重写预设倒计时选项点击事件（新增）
			document.querySelectorAll('.countdown-option').forEach(option => {
			    const time = option.dataset.time;
			    if (time && !['cancel', 'custom', 'pomodoro'].includes(time)) { // 针对15/20/60分钟等预设选项
			        option.addEventListener('click', function(e) {
			            e.stopPropagation(); // 阻止原有事件
			            const duration = parseInt(time) * 60 * 1000;
			            pendingDuration = duration;
			            pendingType = 'normal';
			            document.querySelectorAll('.countdown-option').forEach(opt => opt.classList.remove('active'));
			            this.classList.add('active');
			            document.querySelector('.countdown-option[data-time="cancel"]').style.display = 'block';
			            openGoalInputModal(); // 打开目标输入框
			        }, true); // 捕获阶段触发，优先于原有事件
			    }
			});
			
			// 重写自定义倒计时确认事件（新增）
			const originalConfirmCustom = window.confirmCustomCountdown;
			window.confirmCustomCountdown = function() {
			    // 复用原有验证逻辑
			    const hoursValid = validateTimeInput(document.getElementById('hoursInput'), 0, 23, document.getElementById('hoursError'), true);
			    const minutesValid = validateTimeInput(document.getElementById('minutesInput'), 0, 59, document.getElementById('minutesError'), true);
			    const secondsValid = validateTimeInput(document.getElementById('secondsInput'), 0, 59, document.getElementById('secondsError'), true);
			    if (!hoursValid || !minutesValid || !secondsValid) return;
			
			    const hours = parseInt(document.getElementById('hoursInput').value) || 0;
			    const minutes = parseInt(document.getElementById('minutesInput').value) || 0;
			    const seconds = parseInt(document.getElementById('secondsInput').value) || 0;
			    if (hours === 0 && minutes === 0 && seconds === 0) {
			        [document.getElementById('hoursInput'), document.getElementById('minutesInput'), document.getElementById('secondsInput')].forEach(input => input.classList.add('invalid'));
			        alert('请设置大于0的时间');
			        return;
			    }
			
			    // 保存时长，打开目标输入框
			    pendingDuration = (hours * 3600 + minutes * 60 + seconds) * 1000;
			    pendingType = 'normal';
			    closeCustomCountdownModal();
			    document.querySelector('.countdown-option[data-time="cancel"]').style.display = 'block';
			    openGoalInputModal();
			};
			
			// 重写番茄钟确认事件（新增）
			const originalConfirmPomodoro = window.confirmPomodoro;
			window.confirmPomodoro = function() {
			    // 复用原有验证逻辑
			    const workInput = document.getElementById('workMinutesInput');
			    const restInput = document.getElementById('restMinutesInput');
			    const workValid = validateTimeInput(workInput, 1, 60, document.getElementById('workMinutesError'), true);
			    const restValid = validateTimeInput(restInput, 1, 30, document.getElementById('restMinutesError'), true);
			    if (!workValid || !restValid) return;
			
			    workMinutes = parseInt(workInput.value);
			    restMinutes = parseInt(restInput.value);
			    
			    // 保存时长，打开目标输入框
			    pendingDuration = workMinutes * 60 * 1000;
			    pendingType = 'pomodoro';
			    closePomodoroModal();
			    document.querySelector('.countdown-option[data-time="cancel"]').style.display = 'block';
			    openGoalInputModal();
			};
			
			// 监听主题变化，同步目标模态框（新增）
			const themeObserver = new MutationObserver(() => {
			    updateGoalModalTheme();
			});
			themeObserver.observe(document.body, { attributes: true, attributeFilter: ['class'] });
        });

		// 打开目标输入模态框（新增）
		function openGoalInputModal() {
		    document.getElementById('goalInputModal').classList.add('active');
		    document.getElementById('goalInput').value = '';
		    document.getElementById('goalInput').focus();
		    // 新增：重置错误状态
		    document.getElementById('goalInput').classList.remove('invalid');
		    document.getElementById('goalError').classList.remove('visible');
		    document.getElementById('charCount').textContent = '0';
		    document.getElementById('charCount').style.color = '';
		    updateGoalModalTheme();
		}
		// 监听目标输入框的输入事件，验证最少5字（新增）
		document.getElementById('goalInput').addEventListener('input', function() {
		    const count = this.value.length; // 获取当前输入字数
		    document.getElementById('charCount').textContent = count; // 更新字数显示
		    
		    // 最少5字验证：不足5字时文字标红提醒
		    if (count < 5) {
		        document.getElementById('charCount').style.color = '#ff6666'; // 红色提示
		    } else {
		        document.getElementById('charCount').style.color = ''; // 恢复默认颜色
		    }
		});
		
		// 关闭目标输入模态框（修复版）
		function closeGoalInputModal() {
		    document.getElementById('goalInputModal').classList.remove('active');
		    
		    // 重置状态 - 关键修复
		    pendingDuration = 0;
		    pendingType = '';
		    
		    // 如果没有活跃的倒计时，隐藏取消选项
		    if (!isCountdownActive) {
		        document.querySelector('.countdown-option[data-time="cancel"]').style.display = 'none';
		        
		        // 同时清除所有倒计时选项的选中状态
		        document.querySelectorAll('.countdown-option').forEach(opt => {
		            opt.classList.remove('active');
		        });
		    }
		}
		
		// 确认目标输入并启动倒计时（优化版）
		function confirmGoalInput() {
		    const goalInput = document.getElementById('goalInput');
		    currentGoal = goalInput.value.trim();
		    const errorElement = document.getElementById('goalError');
		    
		    // 验证逻辑
		    if (currentGoal.length < 5) {
		        // 显示错误信息
		        errorElement.classList.add('visible');
		        
		        // 输入框抖动动画
		        goalInput.classList.add('invalid');
		        setTimeout(() => {
		            goalInput.classList.remove('invalid');
		        }, 500);
		        
		        // 聚焦到输入框
		        goalInput.focus();
		        return;
		    }
		    
		    // 验证通过，关闭模态框并启动倒计时
		    errorElement.classList.remove('visible');
		    document.getElementById('goalInputModal').classList.remove('active');
		    
		    // 根据暂存的类型启动倒计时，并显示目标
		    if (pendingType === 'pomodoro') {
		        isPomodoroActive = true;
		        isWorkPhase = true;
		        startCountdown(pendingDuration);
		        document.getElementById('countdownLabel').textContent = `番茄钟 - ${currentGoal}`;
		    } else {
		        startCountdown(pendingDuration);
		        document.getElementById('countdownLabel').textContent = currentGoal;
		    }
		}
		
		// 同步目标模态框主题（新增）
		function updateGoalModalTheme() {
		    const modalContent = document.getElementById('goalModalContent');
		    const goalInput = document.getElementById('goalInput');
		    const isDark = document.body.classList.contains('dark') || (currentTheme === 'auto' && !isDayTime(new Date().getHours() * 60 + new Date().getMinutes()));
		    
		    // 复用现有主题逻辑，确保样式统一
		    if (isDark) {
		        modalContent.style.backgroundColor = `rgb(${lightColors.background[0]}, ${lightColors.background[1]}, ${lightColors.background[2]})`;
		        modalContent.style.color = `rgb(${lightColors.text[0]}, ${lightColors.text[1]}, ${lightColors.text[2]})`;
		        goalInput.style.backgroundColor = `rgb(${lightColors.flip[0]}, ${lightColors.flip[1]}, ${lightColors.flip[2]})`;
		        goalInput.style.color = `rgb(${lightColors.text[0]}, ${lightColors.text[1]}, ${lightColors.text[2]})`;
		    } else {
		        modalContent.style.backgroundColor = `rgb(${darkColors.background[0]}, ${darkColors.background[1]}, ${darkColors.background[2]})`;
		        modalContent.style.color = `rgb(${darkColors.text[0]}, ${darkColors.text[1]}, ${darkColors.text[2]})`;
		        goalInput.style.backgroundColor = `rgb(${darkColors.flip[0]}, ${darkColors.flip[1]}, ${darkColors.flip[2]})`;
		        goalInput.style.color = `rgb(${darkColors.text[0]}, ${darkColors.text[1]}, ${darkColors.text[2]})`;
		    }
		}
		
        // 设置音频按钮事件
        function setupAudioButtons() {
            // 恢复默认按钮
            document.getElementById('resetSoundBtn').addEventListener('click', resetToDefaultSound);
            
            // 预览按钮
            document.getElementById('previewSoundBtn').addEventListener('click', previewSound);
            
            // 禁用状态管理
            const updateAudioButtonStates = () => {
                const isDisabled = isCountdownActive;
                document.getElementById('resetSoundBtn').disabled = isDisabled;
                document.getElementById('previewSoundBtn').disabled = isDisabled;
                document.getElementById('audioFileInput').disabled = isDisabled;
            };
            
            // 初始更新一次
            updateAudioButtonStates();
            
            // 监听倒计时状态变化（通过重写start/stop方法）
            const originalStart = startCountdown;
            startCountdown = function(durationMs) {
                originalStart.call(this, durationMs);
                updateAudioButtonStates();
            };
            
            const originalStop = stopCountdown;
            stopCountdown = function(hideCancel) {
                originalStop.call(this, hideCancel);
                updateAudioButtonStates();
            };
        }

        // 恢复默认提示音
        function resetToDefaultSound() {
            if (isCountdownActive) return;
            
            selectedAudioFile = null;
            document.getElementById('audioFileInput').value = '';
            updateAudioFilenameDisplay();
            alert('已恢复默认提示音');
        }

        // 预览提示音
        function previewSound() {
            if (isCountdownActive) return;
            
            // 先停止当前播放
            stopSound();
            
            // 播放当前选中的提示音
            playCountdownEndSound(true);
        }

        // 停止当前播放的声音
        function stopSound() {
            if (currentAudio) {
                if (currentAudio.pause) {
                    currentAudio.pause();
                }
                currentAudio = null;
            }
            
            // 停止Web Audio API的声音
            if (audioContext) {
                audioContext.close().then(() => {
                    audioContext = null;
                });
            }
            
            // 隐藏停止按钮
            document.getElementById('stopSoundBtn').classList.remove('visible');
        }

        // 更新音频文件名显示
        function updateAudioFilenameDisplay() {
            const filenameEl = document.getElementById('audioFilename');
            if (selectedAudioFile) {
                filenameEl.textContent = `当前选择: ${selectedAudioFile.name}`;
            } else {
                filenameEl.textContent = '未选择文件（使用默认提示音）';
            }
        }

        // 设置时间输入验证
        function setupTimeInputValidation() {
            const inputs = [
                { id: 'hoursInput', min: 0, max: 23, errorId: 'hoursError' },
                { id: 'minutesInput', min: 0, max: 59, errorId: 'minutesError' },
                { id: 'secondsInput', min: 0, max: 59, errorId: 'secondsError' }
            ];
            
            inputs.forEach(input => {
                const element = document.getElementById(input.id);
                const errorElement = document.getElementById(input.errorId);
                
                // 输入事件监听
                element.addEventListener('input', function() {
                    validateTimeInput(this, input.min, input.max, errorElement);
                });
                
                // 失去焦点事件
                element.addEventListener('blur', function() {
                    validateTimeInput(this, input.min, input.max, errorElement, true);
                });
            });
        }

        // 初始化番茄钟输入验证
        function setupPomodoroInputValidation() {
            const inputs = [
                { id: 'workMinutesInput', min: 1, max: 60, errorId: 'workMinutesError' },
                { id: 'restMinutesInput', min: 1, max: 30, errorId: 'restMinutesError' }
            ];
            
            inputs.forEach(input => {
                const element = document.getElementById(input.id);
                const errorElement = document.getElementById(input.errorId);
                
                element.addEventListener('input', function() {
                    validateTimeInput(this, input.min, input.max, errorElement);
                });
                
                element.addEventListener('blur', function() {
                    validateTimeInput(this, input.min, input.max, errorElement, true);
                });
            });
        }

        // 验证时间输入
        function validateTimeInput(input, min, max, errorElement, blur = false) {
            // 移除所有非数字字符
            input.value = input.value.replace(/[^0-9]/g, '');
            
            // 转换为数字
            const value = parseInt(input.value, 10) || 0;
            let isValid = true;
            let errorMessage = '';
            
            // 验证是否为整数（理论上不会出现非整数，因为已过滤非数字）
            if (input.value !== '' && !Number.isInteger(value)) {
                isValid = false;
                errorMessage = `请输入${min}-${max}之间的整数`;
            }
            // 验证范围
            else if (value < min || value > max) {
                isValid = false;
                errorMessage = `请输入${min}-${max}之间的整数`;
            }
            
            // 处理空值（失去焦点时）
            if (blur && input.value === '') {
                input.value = min.toString();
                isValid = true;
            }
            
            // 更新UI状态
            if (!isValid) {
                input.classList.add('invalid');
                errorElement.textContent = errorMessage;
                errorElement.classList.add('visible');
            } else {
                input.classList.remove('invalid');
                errorElement.classList.remove('visible');
            }
            
            return isValid;
        }

        // 设置音频输入处理
        function setupAudioInput() {
            const audioInput = document.getElementById('audioFileInput');
            audioInput.addEventListener('change', handleAudioFileSelect);
        }

        // 处理音频文件选择
        function handleAudioFileSelect(event) {
            // 倒计时进行中不允许修改音频
            if (isCountdownActive) {
                alert('倒计时进行中，无法更改提示音');
                event.target.value = ''; // 清除选择
                return;
            }
            
            const file = event.target.files[0];
            if (!file) {
                selectedAudioFile = null;
                updateAudioFilenameDisplay();
                return;
            }
            
            // 安全验证文件
            const errorMsg = isValidAudioFile(file);
            if (errorMsg) {
                alert(`音频文件验证失败：${errorMsg}`);
                event.target.value = ''; // 清除选择
                selectedAudioFile = null;
                updateAudioFilenameDisplay();
                return;
            }
            
            // 验证通过，保存文件
            selectedAudioFile = file;
            updateAudioFilenameDisplay();
            alert(`已选择提示音：${file.name}`);
        }

        // 验证音频文件（防止文件上传漏洞）
        function isValidAudioFile(file) {
            // 1. 验证文件扩展名
            const validExtensions = ['.mp3', '.wav', '.ogg', '.m4a'];
            const fileName = file.name.toLowerCase();
            const hasValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
            
            if (!hasValidExtension) {
                return `文件扩展名无效，支持的格式：${validExtensions.join('、')}`;
            }
            
            // 2. 验证MIME类型
            const validMimeTypes = [
                'audio/mpeg',    // mp3
                'audio/wav',     // wav
                'audio/ogg',     // ogg
                'audio/mp4'      // m4a
            ];
            
            if (!validMimeTypes.includes(file.type)) {
                return `文件类型不支持，检测到类型：${file.type}，支持的类型：${validMimeTypes.join('、')}`;
            }
            
            // 3. 简单验证文件大小（不超过10MB）
            const maxSizeMB = 10;
            const maxSizeBytes = maxSizeMB * 1024 * 1024;
            if (file.size > maxSizeBytes) {
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                return `文件过大（${fileSizeMB}MB），最大支持${maxSizeMB}MB`;
            }
            
            return null;
        }

        // 获取日出日落时间
        function getSunTimes() {
            const url = `https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lng}&tzid=Asia/shanghai`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        sunrise = parseTime(data.results.sunrise);
                        sunset = parseTime(data.results.sunset);
                        solarNoon = parseTime(data.results.solar_noon);
                        
                        // 显示日出日落信息
                        const sunInfo = document.getElementById('sun-info');
                        sunInfo.textContent = `日出: ${formatTime(sunrise)} | 日落: ${formatTime(sunset)}`;
                        sunInfo.style.display = 'block';
                        
                        // 立即应用一次渐变主题
                        applyGradientTheme();
                    } else {
                        console.error('获取日出日落时间失败:', data.status);
                    }
                })
                .catch(error => {
                    console.error('请求日出日落API失败:', error);
                });
        }

        // 解析时间字符串为分钟数
        function parseTime(timeStr) {
            const [time, period] = timeStr.split(' ');
            const [hours, minutes] = time.split(':').map(Number);
            
            let totalMinutes = hours * 60 + minutes;
            
            if (period === 'PM' && hours !== 12) {
                totalMinutes += 12 * 60;
            }
            if (period === 'AM' && hours === 12) {
                totalMinutes = 0;
            }
            
            return totalMinutes;
        }

        // 将分钟数格式化为时间字符串
        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        // 计算距离目标日期的天数
        function calculateDaysRemaining() {
            const now = new Date();
            const timeDiff = targetDate - now;
            const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            const targetYear = targetDate.getFullYear();
            const targetMonth = targetDate.getMonth() + 1;
            const targetDay = targetDate.getDate();
            
            if (daysRemaining < 0) {
                return `距离${targetYear}年${targetMonth}月${targetDay}日已经过去${Math.abs(daysRemaining)}天`;
            } else if (daysRemaining === 0) {
                return `今天就是${targetYear}年${targetMonth}月${targetDay}日`;
            } else {
                return `距离${targetYear}年${targetMonth}月${targetDay}日还有${daysRemaining}天`;
            }
        }

        // RGB转16进制
        function rgbToHex(r, g, b) {
            return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase()}`;
        }

        // 判断是否为白天（日出到日落）
        function isDayTime(currentMinutes) {
            if (sunrise === null || sunset === null) return false;
            if (sunrise <= sunset) {
                return currentMinutes >= sunrise && currentMinutes <= sunset;
            } else {
                return currentMinutes >= sunrise || currentMinutes <= sunset;
            }
        }

        // 计算亮度比例（0-1）：正午最亮(1)，午夜最暗(0)
        function getBrightnessRatio(currentMinutes) {
            if (solarNoon === null) return 0;
            
            const noonDiff = Math.abs(currentMinutes - solarNoon);
            const ratio = 1 - (noonDiff / 720);
            return Math.max(0, Math.min(1, ratio));
        }

        // HSL转RGB
        function hslToRgb(h, s, l) {
            h /= 360;
            let r, g, b;

            if (s === 0) {
                r = g = b = l; // 灰度
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };

                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }

            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }

        // 生成每秒变化的背景色
        function generateDynamicColor(currentMinutes, currentSeconds) {
            const isDay = isDayTime(currentMinutes);
            const brightnessRatio = getBrightnessRatio(currentMinutes);
            
            const baseBrightness = isDay 
                ? 0.7 + (brightnessRatio * 0.3) 
                : 0.1 + (brightnessRatio * 0.3);
            
            const timeSeed = currentMinutes * 60 + currentSeconds;
            const hueChange = (timeSeed * 5) % 360;
            const smoothHue = lastHue + ((hueChange - lastHue) * 0.7);
            lastHue = smoothHue;
            
            const saturation = isDay 
                ? 0.4 + (Math.sin(timeSeed * 0.1) * 0.2) 
                : 0.3 + (Math.sin(timeSeed * 0.2) * 0.15);
            
            return hslToRgb(smoothHue, saturation, baseBrightness);
        }

        // 应用渐变主题（自动模式）
        function applyGradientTheme() {
            if (!sunrise || !sunset || !solarNoon) return;
            
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const currentSeconds = now.getSeconds();
            const isDay = isDayTime(currentMinutes);
            
            const bgColor = generateDynamicColor(currentMinutes, currentSeconds);
            const textColor = isDay ? lightColors.text : darkColors.text;
            const flipColor = isDay ? lightColors.flip : darkColors.flip;
            const buttonHover = isDay ? lightColors.buttonHover : darkColors.buttonHover;
            
            // 更新颜色信息
            const bgHex = rgbToHex(bgColor[0], bgColor[1], bgColor[2]);
            const flipHex = rgbToHex(flipColor[0], flipColor[1], flipColor[2]);
            document.getElementById('color-info').textContent = `背景色: ${bgHex} | 翻页块: ${flipHex}`;
            document.getElementById('color-info').style.display = 'block';
            
            // 应用背景和文字色
            const body = document.body;
            body.style.backgroundColor = `rgb(${bgColor[0]}, ${bgColor[1]}, ${bgColor[2]})`;
            body.style.color = `rgb(${textColor[0]}, ${textColor[1]}, ${textColor[2]})`;
            
            // 应用所有翻页块颜色（包括倒计时）
            const flipElements = document.querySelectorAll('.flip-front, .flip-back');
            flipElements.forEach(el => {
                el.style.backgroundColor = `rgb(${flipColor[0]}, ${flipColor[1]}, ${flipColor[2]})`;
                el.style.color = `rgb(${textColor[0]}, ${textColor[1]}, ${textColor[2]})`;
                el.style.boxShadow = isDay 
                    ? '0 4px 12px rgba(0, 0, 0, 0.15)' 
                    : '0 4px 12px rgba(0, 0, 0, 0.5)';
            });
            
            // 应用按钮样式
            applyButtonStyles(flipColor, textColor, buttonHover, isDay);
            
            // 更新模态框和停止按钮主题
            updateModalTheme();
            updateStopSoundButtonStyle(isDay);
        }

        // 更新停止提示音按钮样式
        function updateStopSoundButtonStyle(isDay) {
            const stopBtn = document.getElementById('stopSoundBtn');
            const palette = isDay ? lightColors : darkColors;
            const btnPalette = isDay ? darkColors : lightColors;
            
            stopBtn.style.backgroundColor = `rgb(${btnPalette.flip[0]}, ${btnPalette.flip[1]}, ${btnPalette.flip[2]})`;
            stopBtn.style.color = `rgb(${btnPalette.text[0]}, ${btnPalette.text[1]}, ${btnPalette.text[2]})`;
            stopBtn.style.boxShadow = isDay
                ? '0 2px 8px rgba(0, 0, 0, 0.2)'
                : '0 2px 8px rgba(255, 255, 255, 0.2)';
        }

        // 应用静态主题
        function applyStaticTheme(theme) {
            const isDay = theme === 'light';
            const palette = isDay ? lightColors : darkColors;
            
            const body = document.body;
            // 移除旧主题类，添加新主题类（确保主题类正确切换）
            body.classList.remove('light', 'dark');
            body.classList.add(theme);
            
            body.style.backgroundColor = `rgb(${palette.background[0]}, ${palette.background[1]}, ${palette.background[2]})`;
            body.style.color = `rgb(${palette.text[0]}, ${palette.text[1]}, ${palette.text[2]})`;
            
            // 应用所有翻页块颜色（强制选择所有翻页元素，包括倒计时）
            const flipElements = document.querySelectorAll('.flip-front, .flip-back');
            flipElements.forEach(el => {
                el.style.backgroundColor = `rgb(${palette.flip[0]}, ${palette.flip[1]}, ${palette.flip[2]})`;
                el.style.color = `rgb(${palette.text[0]}, ${palette.text[1]}, ${palette.text[2]})`;
                el.style.boxShadow = isDay 
                    ? '0 4px 12px rgba(0, 0, 0, 0.15)' 
                    : '0 4px 12px rgba(0, 0, 0, 0.5)';
            });
            
            // 应用按钮样式
            applyButtonStyles(palette.flip, palette.text, palette.buttonHover, isDay);
            
            // 更新模态框和停止按钮主题
            updateModalTheme();
            updateStopSoundButtonStyle(isDay);
        }

        // 更新模态框主题（与主背景色相反）
        function updateModalTheme() {
            const modalContent = document.getElementById('modalContent');
            const timeInputs = document.querySelectorAll('.time-input');
            const modalBtns = document.querySelectorAll('.modal-btn');
            
            // 判断当前是否为深色模式
            const isDark = document.body.classList.contains('dark') || 
                          (currentTheme === 'auto' && !isDayTime(new Date().getHours() * 60 + new Date().getMinutes()));
            
            if (isDark) {
                // 深色模式下，模态框用浅色背景
                modalContent.style.backgroundColor = `rgb(${lightColors.background[0]}, ${lightColors.background[1]}, ${lightColors.background[2]})`;
                modalContent.style.color = `rgb(${lightColors.text[0]}, ${lightColors.text[1]}, ${lightColors.text[2]})`;
                
                // 输入框样式
                timeInputs.forEach(input => {
                    input.style.backgroundColor = `rgb(${lightColors.flip[0]}, ${lightColors.flip[1]}, ${lightColors.flip[2]})`;
                    input.style.color = `rgb(${lightColors.text[0]}, ${lightColors.text[1]}, ${lightColors.text[2]})`;
                    input.style.borderColor = input.classList.contains('invalid') ? '#ff4444' : '#ddd';
                });
                
                // 错误提示颜色
                document.querySelectorAll('.input-error').forEach(el => {
                    el.style.color = '#cc0000';
                });
                
                // 按钮样式
                modalBtns.forEach(btn => {
                    btn.style.backgroundColor = `rgb(${darkColors.flip[0]}, ${darkColors.flip[1]}, ${darkColors.flip[2]})`;
                    btn.style.color = `rgb(${darkColors.text[0]}, ${darkColors.text[1]}, ${darkColors.text[2]})`;
                });
            } else {
                // 浅色模式下，模态框用深色背景
                modalContent.style.backgroundColor = `rgb(${darkColors.background[0]}, ${darkColors.background[1]}, ${darkColors.background[2]})`;
                modalContent.style.color = `rgb(${darkColors.text[0]}, ${darkColors.text[1]}, ${darkColors.text[2]})`;
                
                // 输入框样式
                timeInputs.forEach(input => {
                    input.style.backgroundColor = `rgb(${darkColors.flip[0]}, ${darkColors.flip[1]}, ${darkColors.flip[2]})`;
                    input.style.color = `rgb(${darkColors.text[0]}, ${darkColors.text[1]}, ${darkColors.text[2]})`;
                    input.style.borderColor = input.classList.contains('invalid') ? '#ff4444' : '#ddd';
                });
                
                // 错误提示颜色
                document.querySelectorAll('.input-error').forEach(el => {
                    el.style.color = '#ff6666';
                });
                
                // 按钮样式
                modalBtns.forEach(btn => {
                    btn.style.backgroundColor = `rgb(${lightColors.flip[0]}, ${lightColors.flip[1]}, ${lightColors.flip[2]})`;
                    btn.style.color = `rgb(${lightColors.text[0]}, ${lightColors.text[1]}, ${lightColors.text[2]})`;
                });
            }
        }

        // 更新番茄钟模态框主题
        function updatePomodoroModalTheme() {
            const modalContent = document.getElementById('pomodoroModalContent');
            const timeInputs = document.querySelectorAll('#pomodoroModal .time-input');
            const modalBtns = document.querySelectorAll('#pomodoroModal .modal-btn');
            
            const isDark = document.body.classList.contains('dark') || 
                          (currentTheme === 'auto' && !isDayTime(new Date().getHours() * 60 + new Date().getMinutes()));
            
            if (isDark) {
                modalContent.style.backgroundColor = `rgb(${lightColors.background[0]}, ${lightColors.background[1]}, ${lightColors.background[2]})`;
                modalContent.style.color = `rgb(${lightColors.text[0]}, ${lightColors.text[1]}, ${lightColors.text[2]})`;
                
                timeInputs.forEach(input => {
                    input.style.backgroundColor = `rgb(${lightColors.flip[0]}, ${lightColors.flip[1]}, ${lightColors.flip[2]})`;
                    input.style.color = `rgb(${lightColors.text[0]}, ${lightColors.text[1]}, ${lightColors.text[2]})`;
                    input.style.borderColor = input.classList.contains('invalid') ? '#ff4444' : '#ddd';
                });
                
                modalBtns.forEach(btn => {
                    btn.style.backgroundColor = `rgb(${darkColors.flip[0]}, ${darkColors.flip[1]}, ${darkColors.flip[2]})`;
                    btn.style.color = `rgb(${darkColors.text[0]}, ${darkColors.text[1]}, ${darkColors.text[2]})`;
                });
            } else {
                modalContent.style.backgroundColor = `rgb(${darkColors.background[0]}, ${darkColors.background[1]}, ${darkColors.background[2]})`;
                modalContent.style.color = `rgb(${darkColors.text[0]}, ${darkColors.text[1]}, ${darkColors.text[2]})`;
                
                timeInputs.forEach(input => {
                    input.style.backgroundColor = `rgb(${darkColors.flip[0]}, ${darkColors.flip[1]}, ${darkColors.flip[2]})`;
                    input.style.color = `rgb(${darkColors.text[0]}, ${darkColors.text[1]}, ${darkColors.text[2]})`;
                    input.style.borderColor = input.classList.contains('invalid') ? '#ff4444' : '#ddd';
                });
                
                modalBtns.forEach(btn => {
                    btn.style.backgroundColor = `rgb(${lightColors.flip[0]}, ${lightColors.flip[1]}, ${lightColors.flip[2]})`;
                    btn.style.color = `rgb(${lightColors.text[0]}, ${lightColors.text[1]}, ${lightColors.text[2]})`;
                });
            }
        }

        // 统一应用按钮样式
        function applyButtonStyles(flipColor, textColor, buttonHover, isDay) {
            const toggleBtns = document.querySelectorAll('.toggle-btn');
            const fullscreenBtn = document.querySelector('.fullscreen-btn');
            const themeOptions = document.querySelector('.theme-options');
            const countdownOptions = document.querySelector('.countdown-options');
            const themeOptionBtns = document.querySelectorAll('.theme-option');
            const countdownOptionBtns = document.querySelectorAll('.countdown-option');
            const audioBtns = document.querySelectorAll('.audio-btn');
            
            // 倒计时进行中禁用相关按钮
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            themeToggleBtn.disabled = isCountdownActive;
            
            // 按钮背景和文字色
            toggleBtns.forEach(btn => {
                btn.style.backgroundColor = `rgb(${flipColor[0]}, ${flipColor[1]}, ${flipColor[2]})`;
                btn.style.color = `rgb(${textColor[0]}, ${textColor[1]}, ${textColor[2]})`;
            });
            
            fullscreenBtn.style.backgroundColor = `rgb(${flipColor[0]}, ${flipColor[1]}, ${flipColor[2]})`;
            fullscreenBtn.style.color = `rgb(${textColor[0]}, ${textColor[1]}, ${textColor[2]})`;
            
            // 音频按钮样式
            audioBtns.forEach(btn => {
                btn.style.backgroundColor = `rgba(0, 0, 0, 0.1)`;
                btn.style.color = `rgb(${textColor[0]}, ${textColor[1]}, ${textColor[2]})`;
                btn.onmouseover = () => {
                    if (!btn.disabled) {
                        btn.style.backgroundColor = `rgba(0, 0, 0, 0.2)`;
                    }
                };
                btn.onmouseout = () => {
                    if (!btn.disabled) {
                        btn.style.backgroundColor = `rgba(0, 0, 0, 0.1)`;
                    }
                };
            });
            
            // 选项菜单样式
            themeOptions.style.backgroundColor = `rgb(${flipColor[0]}, ${flipColor[1]}, ${flipColor[2]})`;
            themeOptions.style.color = `rgb(${textColor[0]}, ${textColor[1]}, ${textColor[2]})`;
            
            countdownOptions.style.backgroundColor = `rgb(${flipColor[0]}, ${flipColor[1]}, ${flipColor[2]})`;
            countdownOptions.style.color = `rgb(${textColor[0]}, ${textColor[1]}, ${textColor[2]})`;
            
            // 音频设置文本颜色
            document.querySelector('.audio-setting-label').style.color = `rgb(${textColor[0]}, ${textColor[1]}, ${textColor[2]})`;
            document.getElementById('audioFilename').style.color = `rgb(${textColor[0]}, ${textColor[1]}, ${textColor[2]})`;
            
            // 选项按钮样式
            [themeOptionBtns, countdownOptionBtns].forEach(btns => {
                btns.forEach(btn => {
                    btn.style.color = `rgb(${textColor[0]}, ${textColor[1]}, ${textColor[2]})`;
                    btn.onmouseover = () => {
                        if (!btn.disabled) {
                            btn.style.backgroundColor = `rgb(${buttonHover[0]}, ${buttonHover[1]}, ${buttonHover[2]})`;
                        }
                    };
                    btn.onmouseout = () => {
                        if (!btn.disabled) {
                            btn.style.backgroundColor = 'transparent';
                        }
                    };
                    if (btn.classList.contains('active')) {
                        btn.style.backgroundColor = isDay 
                            ? 'rgba(0, 0, 0, 0.2)' 
                            : 'rgba(255, 255, 255, 0.2)';
                    }
                });
            });
        }

        // 主题选项设置
        function setupThemeOptions() {
            const options = document.querySelectorAll('.theme-option');
            const sunInfo = document.getElementById('sun-info');
            const colorInfo = document.getElementById('color-info');
            
            options.forEach(option => {
                option.addEventListener('click', () => {
                    // 倒计时进行中不允许修改主题
                    if (isCountdownActive) {
                        return;
                    }
                    
                    options.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    currentTheme = option.dataset.theme;
                    
                    if (currentTheme === 'auto') {
                        getSunTimes();
                        sunInfo.style.display = 'block';
                        colorInfo.style.display = 'block';
                        setTimeout(applyGradientTheme, 100);
                    } else {
                        sunInfo.style.display = 'none';
                        colorInfo.style.display = 'none';
                        applyStaticTheme(currentTheme);
                    }
                });
            });
        }

        // 倒计时选项设置
        function setupCountdownOptions() {
            const options = document.querySelectorAll('.countdown-option');
            const cancelOption = document.querySelector('.countdown-option[data-time="cancel"]');
            
            options.forEach(option => {
                option.addEventListener('click', () => {
                    const time = option.dataset.time;
                    options.forEach(opt => opt.classList.remove('active'));
                    
                    if (time === 'cancel') {
                        stopCountdown();
                        cancelOption.style.display = 'none';
                    } else if (time === 'custom') {
                        openCustomCountdownModal();
                    } else if (time === 'pomodoro') {
                        openPomodoroModal();
                    } else {
                        startCountdown(parseInt(time) * 60 * 1000);
                        option.classList.add('active');
                        cancelOption.style.display = 'block';
                    }
                });
            });
        }

        // 创建倒计时翻页元素
        function createCountdownElements() {
            const countdownClock = document.getElementById('countdownClock');
            countdownClock.innerHTML = ''; // 清空现有内容
            
            // 倒计时翻页元素ID前缀
            const prefix = 'cd-';
            
            // 创建小时十位
            countdownClock.appendChild(createFlipBox(`${prefix}hour-tens`));
            
            // 创建小时个位
            countdownClock.appendChild(createFlipBox(`${prefix}hour-units`));
            
            // 创建分隔符
            const sep1 = document.createElement('div');
            sep1.className = 'separator';
            sep1.textContent = ':';
            countdownClock.appendChild(sep1);
            
            // 创建分钟十位
            countdownClock.appendChild(createFlipBox(`${prefix}minute-tens`));
            
            // 创建分钟个位
            countdownClock.appendChild(createFlipBox(`${prefix}minute-units`));
            
            // 创建分隔符
            const sep2 = document.createElement('div');
            sep2.className = 'separator';
            sep2.textContent = ':';
            countdownClock.appendChild(sep2);
            
            // 创建秒数十位
            countdownClock.appendChild(createFlipBox(`${prefix}second-tens`));
            
            // 创建秒数个位
            countdownClock.appendChild(createFlipBox(`${prefix}second-units`));
        }

        // 创建单个翻页框
        function createFlipBox(id) {
            const flipBox = document.createElement('div');
            flipBox.className = 'flip-box';
            
            const flip = document.createElement('div');
            flip.className = 'flip';
            flip.id = id;
            
            const front = document.createElement('div');
            front.className = 'flip-front';
            front.textContent = '0';
            
            const back = document.createElement('div');
            back.className = 'flip-back';
            back.textContent = '0';
            
            flip.appendChild(front);
            flip.appendChild(back);
            flipBox.appendChild(flip);
            
            return flipBox;
        }

        // 打开自定义倒计时模态框
        function openCustomCountdownModal() {
            document.getElementById('customCountdownModal').classList.add('active');
            document.getElementById('hoursInput').value = 0;
            document.getElementById('minutesInput').value = 0;
            document.getElementById('secondsInput').value = 0;
            
            // 清除错误状态
            document.querySelectorAll('.time-input').forEach(input => {
                input.classList.remove('invalid');
            });
            document.querySelectorAll('.input-error').forEach(el => {
                el.classList.remove('visible');
            });
        }

        // 关闭自定义倒计时模态框（修复版）
        function closeCustomCountdownModal() {
            document.getElementById('customCountdownModal').classList.remove('active');
            
            // 如果没有活跃的倒计时，隐藏取消选项
            if (!isCountdownActive) {
                document.querySelector('.countdown-option[data-time="cancel"]').style.display = 'none';
            }
        }


        // 确认自定义倒计时
        function confirmCustomCountdown() {
            // 验证所有输入
            const hoursValid = validateTimeInput(document.getElementById('hoursInput'), 0, 23, document.getElementById('hoursError'), true);
            const minutesValid = validateTimeInput(document.getElementById('minutesInput'), 0, 59, document.getElementById('minutesError'), true);
            const secondsValid = validateTimeInput(document.getElementById('secondsInput'), 0, 59, document.getElementById('secondsError'), true);
            
            // 如果有无效输入，不继续
            if (!hoursValid || !minutesValid || !secondsValid) {
                return;
            }
            
            // 获取验证后的数值
            const hours = parseInt(document.getElementById('hoursInput').value, 10) || 0;
            const minutes = parseInt(document.getElementById('minutesInput').value, 10) || 0;
            const seconds = parseInt(document.getElementById('secondsInput').value, 10) || 0;
            
            // 确保总时间大于0
            if (hours === 0 && minutes === 0 && seconds === 0) {
                // 显示错误并抖动输入框
                [document.getElementById('hoursInput'), 
                 document.getElementById('minutesInput'), 
                 document.getElementById('secondsInput')].forEach(input => {
                    input.classList.add('invalid');
                });
                alert('请设置大于0的时间');
                return;
            }
            
            // 开始倒计时
            const totalMs = (hours * 3600 + minutes * 60 + seconds) * 1000;
            startCountdown(totalMs);
            closeCustomCountdownModal();
            
            // 显示取消选项
            document.querySelector('.countdown-option[data-time="cancel"]').style.display = 'block';
        }

        // 打开番茄钟模态框
        function openPomodoroModal() {
            document.getElementById('pomodoroModal').classList.add('active');
            // 重置输入框状态
            document.getElementById('workMinutesInput').value = 25;
            document.getElementById('restMinutesInput').value = 5;
            document.querySelectorAll('#pomodoroModal .time-input').forEach(input => {
                input.classList.remove('invalid');
            });
            document.querySelectorAll('#pomodoroModal .input-error').forEach(el => {
                el.classList.remove('visible');
            });
            updatePomodoroModalTheme();
        }

        // 关闭番茄钟模态框
        function closePomodoroModal() {
            document.getElementById('pomodoroModal').classList.remove('active');
        }
		
		

        // 确认番茄钟设置
        function confirmPomodoro() {
            // 验证输入
            const workInput = document.getElementById('workMinutesInput');
            const restInput = document.getElementById('restMinutesInput');
            const workValid = validateTimeInput(workInput, 1, 60, document.getElementById('workMinutesError'), true);
            const restValid = validateTimeInput(restInput, 1, 30, document.getElementById('restMinutesError'), true);
            
            if (!workValid || !restValid) {
                return;
            }
            
            // 保存设置
            workMinutes = parseInt(workInput.value, 10);
            restMinutes = parseInt(restInput.value, 10);
            
            // 开始第一个工作阶段
            isPomodoroActive = true;
            isWorkPhase = true;
            startCountdown(workMinutes * 60 * 1000);
            
            // 更新倒计时标签
            document.getElementById('countdownLabel').textContent = `番茄钟 - 工作中`;
            
            closePomodoroModal();
            document.querySelector('.countdown-option[data-time="cancel"]').style.display = 'block';
        }

        // 开始倒计时
        function startCountdown(durationMs) {
            // 停止现有倒计时（如果存在）
            if (isCountdownActive) {
                stopCountdown(false); // 不隐藏取消选项
            }
            
            // 创建倒计时元素
            createCountdownElements();
            
            // 同步当前主题样式
            if (currentTheme === 'auto') {
                applyGradientTheme(); // 自动模式下同步渐变样式
            } else {
                applyStaticTheme(currentTheme); // 静态模式下同步主题
            }
            
            // 显示倒计时区域
            document.getElementById('countdownSection').style.display = 'flex';
            
            // 显示时间标签
            document.getElementById('clockLabel').classList.add('visible');
            document.getElementById('countdownLabel').classList.add('visible');
            
            // 更新状态
            isCountdownActive = true;
            countdownEndTime = Date.now() + durationMs;
            
            // 禁用主题切换和音频设置
            document.getElementById('themeToggleBtn').disabled = true;
            
            // 替换更新函数
            window.updateTime = updateCountdownTime;
            
            // 立即更新一次
            updateCountdownTime();
        }

        // 停止倒计时
        function stopCountdown(hideCancel = true) {
            if (!isCountdownActive) return;
            
            // 隐藏倒计时区域
            document.getElementById('countdownSection').style.display = 'none';
            
            // 隐藏时间标签
            document.getElementById('clockLabel').classList.remove('visible');
            document.getElementById('countdownLabel').classList.remove('visible');
            
            // 恢复原始更新函数
            window.updateTime = originalUpdateTime;
            
            // 重置状态
            isCountdownActive = false;
            countdownEndTime = null;
            isPomodoroActive = false;
            isWorkPhase = true;
            
            // 恢复倒计时标签文本
            document.getElementById('countdownLabel').textContent = `倒计时`;
            
            // 启用主题切换和音频设置
            document.getElementById('themeToggleBtn').disabled = false;
            
            // 清除倒计时选项的active状态
            document.querySelectorAll('.countdown-option').forEach(opt => {
                opt.classList.remove('active');
            });
            
            // 隐藏取消选项
            if (hideCancel) {
                document.querySelector('.countdown-option[data-time="cancel"]').style.display = 'none';
            }
        }

        // 倒计时模式下的时间更新函数
        function updateCountdownTime() {
            // 保持主题更新
            if (currentTheme === 'auto') {
                applyGradientTheme();
            }
            
            // 更新原时钟显示
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            flipDigit('hour-tens', hours[0]);
            flipDigit('hour-units', hours[1]);
            flipDigit('minute-tens', minutes[0]);
            flipDigit('minute-units', minutes[1]);
            flipDigit('second-tens', seconds[0]);
            flipDigit('second-units', seconds[1]);
            
            // 更新日期和目标倒计时
            const dateStr = now.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            document.getElementById('date').textContent = dateStr;
            document.getElementById('targetCountdown').textContent = calculateDaysRemaining();
            
            // 计算倒计时剩余时间
            const remainingMs = countdownEndTime - Date.now();
            if (remainingMs <= 0) {
                // 倒计时结束
                playCountdownEndSound();
                
                // 检查是否是番茄钟模式，如果是则继续下一个阶段
                if (isPomodoroActive) {
                    // 切换阶段
                    isWorkPhase = !isWorkPhase;
                    
                    // 开始下一个阶段
                    if (isWorkPhase) {
                        startCountdown(workMinutes * 60 * 1000);
                        document.getElementById('countdownLabel').textContent = `番茄钟 - 工作中`;
                    } else {
                        startCountdown(restMinutes * 60 * 1000);
                        document.getElementById('countdownLabel').textContent = `番茄钟 - 休息中`;
                    }
                } else {
                    // 普通倒计时结束
                    stopCountdown();
                }
                return;
            }
            
            // 格式化倒计时时间
            const totalSeconds = Math.floor(remainingMs / 1000);
            const cdHours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const cdMinutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const cdSeconds = (totalSeconds % 60).toString().padStart(2, '0');
            
            // 更新倒计时翻页数字（使用cd-前缀的ID）
            flipDigit('cd-hour-tens', cdHours[0]);
            flipDigit('cd-hour-units', cdHours[1]);
            flipDigit('cd-minute-tens', cdMinutes[0]);
            flipDigit('cd-minute-units', cdMinutes[1]);
            flipDigit('cd-second-tens', cdSeconds[0]);
            flipDigit('cd-second-units', cdSeconds[1]);
        }

        // 播放倒计时结束提示音（增加preview参数用于预览）
        function playCountdownEndSound(preview = false) {
            // 先停止当前播放
            stopSound();
            
            if (selectedAudioFile) {
                // 使用用户选择的音频文件
                const audioUrl = URL.createObjectURL(selectedAudioFile);
                currentAudio = new Audio(audioUrl);
                
                currentAudio.play().then(() => {
                    // 显示停止按钮
                    document.getElementById('stopSoundBtn').classList.add('visible');
                    
                    // 播放结束后清理
                    currentAudio.onended = () => {
                        stopSound();
                        if (!preview) {
                            URL.revokeObjectURL(audioUrl);
                        }
                    };
                }).catch(error => {
                    console.error('播放自定义提示音失败:', error);
                    alert('播放提示音失败，将使用默认提示音');
                    playFallbackSound();
                    if (!preview) {
                        URL.revokeObjectURL(audioUrl);
                    }
                });
            } else {
                // 使用默认提示音
                playFallbackSound();
            }
        }

        // 播放备用提示音
        function playFallbackSound() {
            try {
                // 创建新的音频上下文
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A5音
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                
                // 显示停止按钮
                document.getElementById('stopSoundBtn').classList.add('visible');
                
                // 播放两段声音以增强提示效果
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
                
                // 第一段结束
                setTimeout(() => {
                    if (!audioContext) return; // 已被停止
                    
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
                    
                    // 第二段结束后清理
                    setTimeout(() => {
                        if (oscillator) oscillator.stop();
                        stopSound();
                    }, 500);
                }, 600);
                
                currentAudio = oscillator;
            } catch (error) {
                console.error('播放提示音失败:', error);
                alert('无法播放提示音，请检查浏览器音频设置');
                stopSound();
            }
        }

        // 原始时间更新函数
        function updateTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const dateStr = now.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });

            // 更新日期和目标倒计时
            document.getElementById('date').textContent = dateStr;
            document.getElementById('targetCountdown').textContent = calculateDaysRemaining();

            // 更新翻页数字
            flipDigit('hour-tens', hours[0]);
            flipDigit('hour-units', hours[1]);
            flipDigit('minute-tens', minutes[0]);
            flipDigit('minute-units', minutes[1]);
            flipDigit('second-tens', seconds[0]);
            flipDigit('second-units', seconds[1]);

            // 自动模式下更新颜色
            if (currentTheme === 'auto') {
                applyGradientTheme();
            }
        }

        // 翻页动画
        function flipDigit(elementId, newDigit) {
            const flipElement = document.getElementById(elementId);
            if (!flipElement) return; // 防止元素不存在时出错
            
            const front = flipElement.querySelector('.flip-front');
            const back = flipElement.querySelector('.flip-back');

            if (front.textContent === newDigit) return;

            back.textContent = newDigit;
            flipElement.classList.add('flipping');

            setTimeout(() => {
                front.textContent = newDigit;
                flipElement.classList.remove('flipping');
            }, 600);
        }

        // 全屏切换
        function toggleFullScreen() {
            try {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                }
            } catch (err) {
                console.error(`全屏操作错误: ${err.message}`);
            }
        }
    </script>
</body>
</html>
